<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>ShelfShare | Profile</title>
        <link rel="icon" type="image/x-icon" href="../icon.png">
        <link rel="stylesheet" href="../style.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <!-- For hamburger and social media icons -->
        <style type="text/css">
            .content {
                padding: 20px 20% 50px 20%;
                text-align: justify;
                line-height: 2;
            }
            .content h1 {
                padding-top: 20px;
                padding-bottom: 20px;
                text-align: center;
                line-height: 1.2;
            }

            @media (max-width: 600px) {
                .content {
                    padding: 20px 50px 20px 50px;
                }
            }
        </style>

        <!-- Header -->
        <script src="../header.js"></script>
    </head>

<body>
   <div class="content">
        <div id="profileView">
            <h2>Your Profile</h2>
            <p><strong>Name:</strong> <span id="viewProfileName"></span></p>
            <p><strong>Bio:</strong> <span id="viewProfileBio"></span></p>
            <p><strong>Address:</strong> <span id="viewProfileAddress"></span></p>
            <p><strong>Books:</strong></p>
            <ul id="viewProfileBooks"></ul>
            <button onclick="showEditProfile()">Edit Profile</button>
        </div>

        <div id="profileEdit" style="display: none;">
            <h2>Edit Profile</h2>
            <input type="text" id="editProfileName" placeholder="Name">
            <textarea id="editProfileBio" placeholder="Bio"></textarea>
            <input type="text" id="editProfileAddress" placeholder="Address">
            <textarea id="editProfileBooks" placeholder="Enter book titles, separated by commas"></textarea>
            <button onclick="updateProfile()">Save Profile</button>
            <button onclick="showProfileView()">Cancel</button>
        </div>
    </div>

    <!-- Footer -->
    <script src="footer.js"></script>
    
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
            if (!currentUser) {
                window.location.href = 'index.html'; // Redirect to login if not logged in
                return;
            }
        
            // Display the user's profile
            document.getElementById('viewProfileName').innerText = currentUser.name || 'No name set';
            document.getElementById('viewProfileBio').innerText = currentUser.bio || 'No bio set';
            document.getElementById('viewProfileAddress').innerText = currentUser.address || 'No address set';
        
            const booksList = document.getElementById('viewProfileBooks');
            booksList.innerHTML = '';
            (currentUser.books || []).forEach(book => {
                const li = document.createElement('li');
                li.innerText = book;
                booksList.appendChild(li);
            });
        });

        // Display profile data
        function showProfileView() {
          document.getElementById('profileEdit').style.display = 'none';
          document.getElementById('profileView').style.display = 'block';
        
          document.getElementById('viewProfileName').innerText = currentUser.name || 'No name set';
          document.getElementById('viewProfileBio').innerText = currentUser.bio || 'No bio set';
          document.getElementById('viewProfileAddress').innerText = currentUser.address || 'No address set';
        
          const booksList = document.getElementById('viewProfileBooks');
          booksList.innerHTML = '';
          (currentUser.books || []).forEach(book => {
            const li = document.createElement('li');
            li.innerText = book;
            booksList.appendChild(li);
          });
        }
        
        function showEditProfile() {
          document.getElementById('profileView').style.display = 'none';
          document.getElementById('profileEdit').style.display = 'block';
        
          document.getElementById('editProfileName').value = currentUser.name || '';
          document.getElementById('editProfileBio').value = currentUser.bio || '';
          document.getElementById('editProfileAddress').value = currentUser.address || '';
          document.getElementById('editProfileBooks').value = (currentUser.books || []).join(', ');
        }
        
        async function updateProfile() {
          const name = document.getElementById('editProfileName').value;
          const bio = document.getElementById('editProfileBio').value;
          const address = document.getElementById('editProfileAddress').value;
          const books = document.getElementById('editProfileBooks').value.split(',').map(b => b.trim());
        
          try {
            const response = await fetch('/update-profile', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: currentUser.username, name, bio, address, books }),
            });
        
            if (response.ok) {
              currentUser.name = name;
              currentUser.bio = bio;
              currentUser.address = address;
              currentUser.books = books;
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              showProfileView();
            } else {
              alert('Failed to update profile.');
            }
          } catch (error) {
            console.error('Error updating profile:', error);
            alert('An error occurred while updating your profile.');
          }
        }
    </script>
</body>
</html>
