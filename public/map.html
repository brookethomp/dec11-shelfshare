<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="description" content="ShelfShare is a community-based platform that allows local book lovers to easily exchange books with each other through a flexible subscription model, promoting affordable reading and sustainability.">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>ShelfShare | Book Map</title>
        <link rel="icon" type="image/x-icon" href="icon.png">
        <link rel="stylesheet" href="style.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

        <style type="text/css">
            .content {
                border: 2px solid #4C4C4C;
                border-radius: 5px;
                margin: 20px 20% 10px 20%;
                padding: 30px;
                background-color: rgba(255, 255, 255, 0.3);
            }
            .content h2 {
                padding-bottom: 0px;
            }
            .content2 {
                padding-bottom: 20px;
                text-align: justify;
                font-size: 16px;
                line-height: 2;
            }
            .content2 input {
                border: 1px solid #4C4C4C;
                border-radius: 5px;
                padding: 1px 4px;
                color: #4C4C4C;
                font-size: 14px;
            }
            .content2 button {
                border: 1px solid #4C4C4C;
                border-radius: 5px;
                color: #4C4C4C;
                font-size: 14px;
            }

            #map {
                z-index: 0;
                height: 500px;
                width: 90%;
                margin-bottom: 20px;
            }

            h1 {
                padding-top: 50px;
                padding-bottom: 20px;
                text-align: center;
            }
            h3 {
                padding-top: 10px;
            }
        </style>

        <script src="header.js"></script>
    </head>

    <body>
        <h1>SwapSpot Map</h1>

        <div class="content">
            <div class="content2">
                <p>Enter or click on a location to see nearby SwapSpots and their books!</p>
                <p>Click <strong>Find Location</strong> to find nearby locations.</p>
                <p>Locations will be displayed within the radius you selected.</p>
            </div>

            <div class="content2">
                <label for="radius">Radius (miles):</label>
                <input type="number" id="radius" value="1" min="0" max="200">
                <br>
                <label for="address">Enter an Address:</label>
                <input type="text" id="address" value="Tufts University, 419 Boston Ave, Medford, MA 02155">
                <button onclick="getLocation()">Find Location</button>
            </div>

            <div class="content2">
                <div id="map"></div>
                <div>
                    <label for="searchBook">Enter a book to search for:</label>
                    <input type="text" id="searchBook" value="" oninput="getBook()">
                    <button onclick="getBook()">Search</button>
                    <div id="searchedBooksHeader"></div>
                    <div id="searchedBooks"></div>
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            let map, locSelected = null;
            let circle = null, markerSelected = null;
            let swapLocations = [];

            document.addEventListener('DOMContentLoaded', () => {
                map = L.map('map').setView([42.4, -71.15], 14);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                map.on('click', function(e) {
                    if (circle) map.removeLayer(circle);
                    if (markerSelected) map.removeLayer(markerSelected);

                    locSelected = e.latlng;

                    newLocation(locSelected);
                    fetchSwapLocations();
                });

                fetchSwapLocations();
            });

            async function fetchSwapLocations() {
                if (!locSelected) {
                    alert("Please select a location first.");
                    return;
                }

                const radius = document.getElementById("radius").value;

                try {
                    const response = await fetch(`/get-swap-locations?lat=${locSelected.lat}&lng=${locSelected.lng}&radius=${radius}`);
                    const data = await response.json();

                    if (response.ok) {
                        swapLocations = data.map(user => ({
                            name: user.name,
                            books: user.books,
                            lat: user.location.coordinates[1], // Latitude
                            lng: user.location.coordinates[0], // Longitude
                            distance: user.distance // Distance in meters
                        }));
                        addSwapLocationsToMap();
                    } else {
                        console.error('Failed to fetch swap locations:', response.statusText);
                    }
                } catch (error) {
                    console.error('Error fetching swap locations:', error);
                }
            }

            function addSwapLocationsToMap() {
                const bookIcon = L.icon({
                    iconUrl: 'bookMarker.png',
                    iconSize: [55, 55],
                    iconAnchor: [25, 42],
                    popupAnchor: [1, -42]
                });

                swapLocations.forEach(function(location) {
                    let booksHere = "<ul>";
                    location.books.forEach(function(book) {
                        booksHere += "<li>" + book + "</li>";
                    });
                    booksHere += "</ul>";

                    L.marker([location.lat, location.lng], { icon: bookIcon })
                        .bindPopup(`<h3>${location.name}</h3>
                                    <p>Distance: ${(location.distance / 1609.34).toFixed(2)} miles</p>
                                    <h4>Books:</h4>${booksHere}`)
                        .addTo(map);
                });
            }

            function getLocation() {
                const address = document.getElementById("address").value;
                if (!address || document.getElementById("radius").value <= 0) {
                    alert("Please enter a valid address and radius.");
                    return;
                }

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.length > 0) {
                            if (circle) map.removeLayer(circle);
                            if (markerSelected) map.removeLayer(markerSelected);

                            locSelected = L.latLng(data[0].lat, data[0].lon);
                            map.setView(locSelected, 14);

                            newLocation(locSelected);
                            fetchSwapLocations();
                        } else {
                            alert("Cannot find address.");
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching location:", error);
                        alert("There was an error fetching the location.");
                    });
            }

            function newLocation(location) {
                const personIcon = L.icon({
                    iconUrl: 'peopleMarker.png',
                    iconSize: [50, 50],
                    iconAnchor: [25, 42],
                    popupAnchor: [1, -42]
                });

                markerSelected = L.marker(location, { icon: personIcon }).addTo(map).bindPopup("Your Location").openPopup();
                circle = L.circle(location, {
                    color: '#3A7CA5',
                    fillColor: '#A8C4A0',
                    fillOpacity: 0.4,
                    radius: document.getElementById("radius").value * 1609.34
                }).addTo(map);
            }
        </script>

        <script src="footer.js"></script>
    </body>
</html>
